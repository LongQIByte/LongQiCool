---
title: 'GitHub Actions 自动构建并推送镜像到阿里云'
date: '2025-01-15'
tags: ['GitHub Actions', 'Docker', 'CI/CD', '阿里云', 'ACR', 'DevOps']
draft: false
summary: '详细介绍如何使用GitHub Actions实现Docker镜像的自动构建和多平台推送，包括阿里云ACR集成、多镜像并行构建和缓存优化策略。'
images: ['/static/images/github-action/image.png']
authors: ['default']
layout: PostLayout
---

## 概述

在软件开发过程中，除了开发工作外，测试和部署也是重要的环节。GitHub Actions 提供了强大的 CI/CD 功能，通过流程化的方式简化了测试和部署过程。

本文将介绍如何使用 GitHub Actions 实现：

- 自动构建 Docker 镜像
- 多平台架构支持
- 自动推送到阿里云容器镜像服务（ACR）
- 多镜像并行构建

## GitHub Actions 配置

### 创建配置文件

在项目根目录创建 `.github/workflows/docker-build-acr.yml` 文件：

```yaml
name: Docker Build & Push (Aliyun ACR)

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*'

jobs:
  upload_to_acr:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dockerfile: docker/Dockerfile.model
            image_name: your-app-model
            platforms: linux/amd64,linux/arm64
          - dockerfile: docker/Dockerfile.service
            image_name: your-app-service
            platforms: linux/amd64,linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 多平台架构构建工具
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 登录阿里云 ACR
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # 元数据生成（只保留 ACR）
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${{ matrix.image_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=latest,enable={{is_default_branch}}

      # 构建并推送
      - name: Build and push to ACR
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: ${{ matrix.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

### 配置说明

#### 触发条件

- **分支推送**：当代码推送到 `main` 或 `dev` 分支时触发
- **标签推送**：当推送以 `v` 开头的标签时触发（如 `v1.0.0`）

#### 多镜像构建

使用 `matrix` 策略同时构建多个 Docker 镜像：

- `your-app-model`：应用模型镜像
- `your-app-service`：应用服务镜像

#### 多平台支持

每个镜像都支持 `linux/amd64` 和 `linux/arm64` 两种架构，确保在不同平台上都能正常运行。

## 环境变量配置

### 必需的 Secrets

在 GitHub 仓库的 Settings → Secrets and variables → Actions 中配置以下环境变量：

| 变量名             | 说明                     | 示例值                              |
| ------------------ | ------------------------ | ----------------------------------- |
| `ALIYUN_REGISTRY`  | 阿里云容器镜像服务地址   | `registry.cn-hangzhou.aliyuncs.com` |
| `ALIYUN_USERNAME`  | 阿里云账号用户名         | `your_username`                     |
| `ALIYUN_PASSWORD`  | 阿里云账号密码或访问令牌 | `your_password_or_token`            |
| `ALIYUN_NAMESPACE` | 容器镜像命名空间         | `your_namespace`                    |

### 配置步骤

1. 登录阿里云控制台
2. 进入容器镜像服务（ACR）
3. 获取注册表地址和命名空间
4. 在 GitHub 仓库中配置对应的 Secrets

![GitHub Actions 配置界面](/static/images/github-action/image.png)
